name: Run Unit Tests
description: Run C# unit tests and publish results
runs:
  using: composite
  steps:
    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: '8.0.x'

    - name: Restore dependencies
      shell: pwsh
      run: dotnet restore

    - name: Build solution
      shell: pwsh
      run: dotnet build --configuration Release --no-restore

    - name: Run C# unit tests
      shell: pwsh
      run: dotnet test --configuration Release --no-build --verbosity normal --logger "trx;LogFileName=unit-tests.trx" --collect "XPlat Code Coverage" --results-directory ./test-results

    - name: Upload test results
      uses: actions/upload-artifact@v6
      if: always()
      with:
        name: test-results-${{ matrix.os }}
        path: test-results/

    - name: Publish test results
      uses: EnricoMi/publish-unit-test-result-action@v2
      if: always() && matrix.os == 'ubuntu-latest'
      with:
        job_summary: true
        check_run: false
        comment_mode: off
        fail_on: test failures
        files: test-results/**/*.trx
        check_name: Unit Test Results
