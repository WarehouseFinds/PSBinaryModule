{
  "name": "PowerShell-PSBinaryModule",
  "image": "mcr.microsoft.com/devcontainers/dotnet:10.0",

  "features": {
    "ghcr.io/devcontainers/features/powershell:1": {
      "version": "stable"
    },
    "ghcr.io/devcontainers/features/github-cli:1": {
      "version": "latest"
    },
    "ghcr.io/devcontainers/features/node:1": {
      "version": "lts"
    }
  },

  "customizations": {
    "vscode": {
      "settings": {
        // Set default terminals
        "terminal.integrated.enablePersistentSessions": false,
        "terminal.integrated.defaultProfile.linux": "pwsh",
        "terminal.integrated.profiles.linux": {
          "bash": {
            "path": "bash"
          },
          "pwsh": {
            "path": "pwsh"
          }
        },

        // Workspace settings
        "workbench.startupEditor": "none",

        // GitHub Copilot
        "github.copilot.chat.enableTerminalIntegration": true,

        // MCPP server for GitHub Codespaces
        "chat.mcp.servers": {
          "github": {
            "command": "server-github"
          }
        },

        // PowerShell extension
        "powershell.integratedConsole.showOnStartup": false,
        "powershell.startAsLoginShell.linux": false,

        // C# extension
        "dotnet.defaultSolution": "PSBinaryModule.sln",
        "dotnet.server.useGlobalDotnet": true,
        "dotnet.automaticallyUseSDKsFromPath": true,

        // Test Explorer
        "dotnet-test-explorer.testProjectPath": "**/*.Tests.csproj",

        // Disable extension recommendations
        "extensions.ignoreRecommendations": true
      },

      "extensions": [
        "ms-vscode.powershell",
        "ms-dotnettools.csdevkit",
        "pspester.pester-test",
        "editorconfig.editorconfig",
        "DavidAnson.vscode-markdownlint"
      ],

      "remote.extensionKind": {
        "github.copilot": [ "ui" ],
        "github.copilot-chat": [ "ui" ],
        "github.vscode-github-actions": [ "ui" ]
      }
    }
  },

  // Install PowerShell modules on container creation
  "onCreateCommand": "pwsh -NoProfile -Command 'Install-PSResource -Name InvokeBuild, Pester -TrustRepository -AcceptLicense -Verbose'",

  // Update PowerShell to latest stable and remove preview versions
  //"postCreateCommand": "sudo apt-get update; sudo apt-get remove -y powershell-preview; sudo apt-get install -y powershell",

  // Restore .NET dependencies, install latest MCP server
  "postStartCommand": "dotnet restore && npm install -g @modelcontextprotocol/server-github@latest",

  // Reinitialize C# extension and confirm setup
  "postAttachCommand": "pwsh -NoProfile -Command 'Write-Host \"Dev container ready. .NET SDK $(dotnet --version) and PowerShell $($PSVersionTable.PSVersion) available.\"'",

  "waitFor": "postAttachCommand",

  // Mount git config and GitHub CLI config
  "mounts": [
    "source=${localEnv:HOME}${localEnv:USERPROFILE}/.gitconfig,target=/home/vscode/.gitconfig,type=bind,consistency=cached",
    "source=${localEnv:HOME}${localEnv:USERPROFILE}/.config/gh,target=/home/vscode/.config/gh,type=bind,consistency=cached"
  ],

  "remoteUser": "vscode"
}
